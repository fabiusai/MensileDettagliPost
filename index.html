<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creatore Grafico Notizie</title>
    <link rel="icon" href="favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-primary: #FFCC00;
            --color-secondary: #003d82;
            --color-accent: #0066cc;
            --color-text-primary: #1a1a1a;
            --color-text-secondary: #666666;
            --color-text-muted: #999999;
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f8f9fa;
            --color-bg-light: #fafbfc;
            --color-border: #e1e5e9;
            --color-border-light: #f0f2f4;
            --color-success: #28a745;
            --color-hover: #fff5cc;
            --border-radius: 8px;
            --box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --transition: all 0.2s ease;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg-light) 100%);
            color: var(--color-text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; padding: 30px 0; }
        .header h1 { font-size: 2.8rem; font-weight: 300; color: var(--color-secondary); margin: 0; letter-spacing: -0.02em; }
        .header .subtitle { font-size: 1.1rem; color: var(--color-text-secondary); margin-top: 8px; font-weight: 400; }
        
        /* New File Upload Bar */
        .file-upload-bar {
            background: var(--color-bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px 25px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--color-border);
        }
        .file-upload-bar .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .file-upload-bar .file-upload-button {
            padding: 10px 20px;
        }
        .file-upload-bar .file-name {
            margin-top: 0;
            font-size: 1rem;
            flex-grow: 1;
        }

        /* Workflow container now for a single column */
        .workflow-container { 
            display: block; /* Removed grid to allow full width */
            margin-bottom: 32px; 
        } 
        .workflow-step {
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 28px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            margin-bottom: 24px; /* Add margin for spacing between main section and preview */
        }
        .workflow-step::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-accent) 100%);
        }
        .workflow-step:hover { border-color: var(--color-primary); box-shadow: var(--box-shadow-hover); transform: translateY(-2px); }
        .step-header { display: flex; align-items: center; margin-bottom: 16px; }
        /* Removed step-number styles as it's no longer present */
        .step-title { font-size: 1.25rem; font-weight: 600; color: var(--color-secondary); margin: 0; }
        .step-description { color: var(--color-text-secondary); font-size: 0.95rem; margin: 0 0 24px 0; line-height: 1.5; }
        .file-input { display: none; }
        .file-upload-button {
            background: var(--color-primary); color: var(--color-text-primary);
            border: none; padding: 12px 24px; border-radius: var(--border-radius);
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
        }
        .file-upload-button:hover { background: #e6b800; transform: translateY(-1px); }
        .file-upload-button:active { transform: translateY(0); }
        .file-name { margin-top: 12px; font-size: 0.9rem; color: var(--color-text-muted); }
        .file-name.has-file { color: var(--color-success); font-weight: 500; }
        .data-table-container {
            background: var(--color-bg-primary); border: 1px solid var(--color-border);
            border-radius: var(--border-radius); overflow: hidden; margin-bottom: 20px;
            max-height: 600px; /* Increased height for data table */
            overflow-y: auto;
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th {
            background: var(--color-secondary); color: white;
            padding: 14px 12px; text-align: left; font-weight: 600;
            position: sticky; top: 0; z-index: 10;
        }
        .data-table td { 
            padding: 12px; border-bottom: 1px solid var(--color-border-light); 
            /* max-width removed to allow columns to self-adjust better */
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: normal; /* Allow wrap for table cells */
        }
        .data-table td.label-cell { max-width: 120px; } /* Compact Label */
        .data-table td.data-cell { max-width: 100px; } /* Compact Data */
        .data-table td.argomento-cell { max-width: 200px; } /* Argomento */
        .data-table td.copy-cell {
            max-width: 350px; /* More width for copy */
            white-space: normal; /* Allow natural wrapping for textarea content */
        }

        .data-table tbody tr:hover { background: var(--color-bg-light); }
        .data-table tbody tr.selected { background: #e6f3ff; color: var(--color-secondary); }
        .radio-input { width: 16px; height: 16px; accent-color: var(--color-primary); }
        .editable-text-input, .editable-textarea-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
            color: inherit;
            background: transparent;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s ease;
        }
        .editable-text-input:focus, .editable-textarea-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
        }
        .editable-textarea-input {
            resize: vertical; /* Allow vertical resizing for textarea */
            min-height: 2.5em; /* Approximately 2 lines */
            max-height: 6.5em; /* Approximately 5 lines (1.3em * 5) */
            line-height: 1.3em; /* Adjust line height for better multi-line display */
            overflow-y: auto; /* Show scrollbar if content exceeds max-height */
        }


        .action-button {
            background: var(--color-secondary); color: white;
            border: none; padding: 12px 24px; border-radius: var(--border-radius);
            font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: var(--transition);
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 48px;
            margin-bottom: 15px; /* Added margin for better spacing */
        }
        .action-button:hover:not(:disabled) { background: #002a5c; transform: translateY(-1px); }
        .action-button:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; }
        .action-button.success { background: var(--color-success); }
        .action-button.loading { background: var(--color-accent); position: relative; }
        .loading-spinner { width: 16px; height: 16px; border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Preview section now below the main step */
        .preview-section { 
            background: var(--color-bg-primary); 
            border: 2px solid var(--color-border); 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        .preview-header { background: var(--color-bg-secondary); padding: 20px 28px; border-bottom: 1px solid var(--color-border); }
        .preview-title { font-size: 1.25rem; font-weight: 600; color: var(--color-secondary); margin: 0; }
        .preview-content { 
            flex-grow: 1; /* Allow content to grow */
            padding: 28px; 
            min-height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #fafbfc; 
        }
        .preview-placeholder { text-align: center; color: var(--color-text-muted); font-size: 1.1rem; }
        .preview-content svg { max-width: 100%; height: auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); background: white; }
        .success-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 12px 16px; border-radius: var(--border-radius); margin-top: 16px; font-size: 0.9rem; display: none; align-items: center; gap: 8px; }
        .success-message.show { display: flex; }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="header">
            <h1>Creatore Grafico Notizie</h1>
            <p class="subtitle">Strumento per la generazione automatica di grafiche SVG da dati Excel</p>
        </header>

        <!-- New File Upload Bar -->
        <div class="file-upload-bar">
            <div class="file-input-wrapper">
                <input type="file" id="excelFile" class="file-input" accept=".xlsx">
                <label for="excelFile" class="file-upload-button"><span>üìÅ</span> Carica File Excel</label>
                <div id="fileName" class="file-name">Nessun file selezionato</div>
            </div>
        </div>

        <div class="workflow-container">
            <!-- Main data selection and edit section -->
            <div class="workflow-step">
                <div class="step-header">
                    <h2 class="step-title">Seleziona e Modifica Dati</h2>
                </div>
                <p class="step-description">Scegli una riga dalla tabella per visualizzare l'anteprima e, se necessario, modifica l'argomento e il testo del copy.</p>
                <div class="data-table-container">
                    <table id="dataTable" class="data-table">
                        <thead>
                            <tr>
                                <th style="width:40px;"></th><th>Label</th><th>Data</th><th>Argomento</th><th>Copy</th>
                            </tr>
                        </thead>
                        <tbody><tr><td colspan="5" style="text-align:center;color:var(--color-text-muted);padding:40px;">Carica un file Excel per visualizzare i dati</td></tr></tbody>
                    </table>
                </div>
                
                <button id="previewSvgBtn" class="action-button" disabled><span>üëÅÔ∏è</span><span class="button-text">Genera Anteprima</span></button>
                <button id="downloadSvgBtn" class="action-button" disabled><span>‚¨áÔ∏è</span><span class="button-text">Scarica SVG</span></button>
                <div id="downloadMessage" class="success-message"><span>‚úÖ</span><span>File SVG scaricato con successo!</span></div>
            </div>
            
            <!-- Preview Section (Moved below the main step) -->
            <div class="preview-section">
                <div class="preview-header"><h2 class="preview-title">Anteprima Grafico</h2></div>
                <div class="preview-content" id="svgPreviewContainer">
                    <div class="preview-placeholder">L'anteprima del grafico SVG generato apparir√† qui dopo aver selezionato una riga e aver cliccato su "Genera Anteprima"</div>
                </div>
            </div>
        </div>
    </div>
<script>
const excelFile = document.getElementById('excelFile');
const fileNameSpan = document.getElementById('fileName');
const dataTableBody = document.querySelector('#dataTable tbody');
const previewSvgBtn = document.getElementById('previewSvgBtn');
const downloadSvgBtn = document.getElementById('downloadSvgBtn');
const svgPreviewContainer = document.getElementById('svgPreviewContainer');
const downloadMessage = document.getElementById('downloadMessage');

let data = []; // This will store the raw data from the Excel file
let displayData = []; // This will store the data formatted for display and editing
let selectedRowIndex = -1; // Index in displayData, corresponds to original Excel row index - 1

excelFile.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        fileNameSpan.textContent = file.name;
        fileNameSpan.classList.add('has-file');
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(e.target.result, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            processAndDisplayTable(data);
            resetSelection();
        };
        reader.readAsArrayBuffer(file);
    } else {
        fileNameSpan.textContent = 'Nessun file selezionato';
        fileNameSpan.classList.remove('has-file');
        dataTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--color-text-muted);padding:40px;">Carica un file Excel per visualizzare i dati</td></tr>';
        resetSelection();
    }
});

// Helper function to truncate text for display in textarea if needed, but primarily for initial value
function formatTextForTextarea(text) {
    if (!text) return '';
    // No strict truncation here, textarea will handle lines up to its max-height
    return text;
}


function processAndDisplayTable(excelData) {
    dataTableBody.innerHTML = '';
    if (excelData.length < 2) return;

    const headers = excelData[0];
    const relevantHeaders = ["Label", "Data", "Argomento", "Copy", "Visualizzazioni", "Interazioni"];
    const headerIndices = relevantHeaders.map(h => headers.indexOf(h));

    displayData = []; // Clear previous display data

    for (let i = 1; i < excelData.length; i++) {
        const rowData = excelData[i];
        const rowObj = {};
        relevantHeaders.forEach((header, idx) => {
            rowObj[header] = rowData[headerIndices[idx]] || '';
        });
        displayData.push(rowObj);

        const tr = document.createElement('tr');
        tr.dataset.displayIndex = i - 1; // Index in displayData array

        const selectTd = document.createElement('td');
        selectTd.innerHTML = `<input type="radio" name="selectRow" value="${i - 1}" class="radio-input">`;
        tr.appendChild(selectTd);

        // Label
        const labelTd = document.createElement('td');
        labelTd.className = 'label-cell';
        labelTd.textContent = rowObj.Label;
        labelTd.title = rowObj.Label;
        tr.appendChild(labelTd);

        // Data
        const dataTd = document.createElement('td');
        dataTd.className = 'data-cell';
        dataTd.textContent = rowObj.Data;
        dataTd.title = rowObj.Data;
        tr.appendChild(dataTd);

        // Argomento (Editable)
        const argomentoTd = document.createElement('td');
        argomentoTd.className = 'argomento-cell';
        const argomentoInput = document.createElement('input');
        argomentoInput.type = 'text';
        argomentoInput.className = 'editable-text-input';
        argomentoInput.value = rowObj.Argomento;
        argomentoInput.dataset.originalValue = rowObj.Argomento; // Store original value
        argomentoInput.addEventListener('input', (event) => {
            displayData[i - 1].Argomento = event.target.value; // Update displayData on input
            if (selectedRowIndex === (i-1)) { // If currently selected row is being edited
                // Re-generate preview if already showing, otherwise just update data
                if (svgPreviewContainer.querySelector('svg')) {
                    const currentSelectedRowData = displayData[selectedRowIndex];
                    const generatedSvg = generateSvg(currentSelectedRowData);
                    svgPreviewContainer.innerHTML = generatedSvg;
                }
            }
        });
        argomentoTd.appendChild(argomentoInput);
        tr.appendChild(argomentoTd);

        // Copy (Editable Textarea, up to 5 lines)
        const copyTd = document.createElement('td');
        copyTd.className = 'copy-cell';
        const copyTextarea = document.createElement('textarea');
        copyTextarea.className = 'editable-textarea-input';
        copyTextarea.rows = 5; // Initial rows hint for display
        copyTextarea.value = formatTextForTextarea(rowObj.Copy);
        copyTextarea.dataset.originalValue = rowObj.Copy; // Store original value
        copyTextarea.addEventListener('input', (event) => {
            displayData[i - 1].Copy = event.target.value; // Update displayData on input
            if (selectedRowIndex === (i-1)) { // If currently selected row is being edited
                if (svgPreviewContainer.querySelector('svg')) {
                    const currentSelectedRowData = displayData[selectedRowIndex];
                    const generatedSvg = generateSvg(currentSelectedRowData);
                    svgPreviewContainer.innerHTML = generatedSvg;
                }
            }
        });
        copyTd.appendChild(copyTextarea);
        tr.appendChild(copyTd);

        dataTableBody.appendChild(tr);
    }

    document.querySelectorAll('input[name="selectRow"]').forEach(radio => {
        radio.addEventListener('change', (event) => {
            if (event.target.checked) {
                document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
                const currentRow = event.target.closest('tr');
                currentRow.classList.add('selected');
                selectedRowIndex = parseInt(event.target.value); // Index in displayData
                previewSvgBtn.disabled = false;
                downloadSvgBtn.disabled = false;
            }
        });
    });
}

function resetSelection() {
    selectedRowIndex = -1;
    previewSvgBtn.disabled = true;
    downloadSvgBtn.disabled = true;
    svgPreviewContainer.innerHTML = '<div class="preview-placeholder">L\'anteprima del grafico SVG generato apparir√† qui dopo aver selezionato una riga e aver cliccato su "Genera Anteprima"</div>';
    downloadMessage.classList.remove('show');
    document.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
    document.querySelectorAll('input[name="selectRow"]').forEach(r => r.checked = false);
}

function setButtonState(button, state, text) {
    const buttonText = button.querySelector('.button-text');
    button.className = `action-button ${state}`;
    if (state === 'loading') {
        buttonText.innerHTML = `<span class="loading-spinner"></span> ${text}`;
    } else {
        buttonText.textContent = text;
    }
}

previewSvgBtn.addEventListener('click', () => {
    if (selectedRowIndex !== -1) {
        setButtonState(previewSvgBtn, 'loading', 'Generazione in corso...');
        setTimeout(() => {
            const selectedRowData = displayData[selectedRowIndex]; // Use displayData for current values
            const generatedSvg = generateSvg(selectedRowData);
            svgPreviewContainer.innerHTML = generatedSvg;
            setButtonState(previewSvgBtn, 'success', 'Anteprima Generata!');
            setTimeout(() => { setButtonState(previewSvgBtn, '', 'Genera Anteprima'); }, 1500);
        }, 500);
    }
});

downloadSvgBtn.addEventListener('click', () => {
    if (selectedRowIndex !== -1) {
        setButtonState(downloadSvgBtn, 'loading', 'Download in corso...');
        setTimeout(() => {
            const selectedRowData = displayData[selectedRowIndex]; // Use displayData for current values
            const generatedSvg = generateSvg(selectedRowData);
            const blob = new Blob([generatedSvg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Use Label and Argomento for a more descriptive file name
            const fileNameLabel = selectedRowData.Label.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
            const fileNameArgomento = selectedRowData.Argomento.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
            a.download = `notizia-${fileNameLabel}-${fileNameArgomento}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            setButtonState(downloadSvgBtn, 'success', 'Download Completato!');
            downloadMessage.classList.add('show');
            setTimeout(() => { setButtonState(downloadSvgBtn, '', 'Scarica SVG'); downloadMessage.classList.remove('show'); }, 3000);
        }, 800);
    }
});

function formatNumber(num) {
    if (typeof num !== 'number') {
        num = parseFloat(num);
        if (isNaN(num)) return '';
    }
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1).replace('.', ',') + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1).replace('.', ',') + 'K';
    }
    return num.toString().replace('.', ',');
}

function generateSvg(rowData) { // rowData is now the processed object from displayData
    const label = rowData.Label;
    const dataPubblicazione = rowData.Data;
    const argomento = rowData.Argomento; // This will be the editable value
    let copyText = rowData.Copy; // This will be the editable value
    const visualizzazioni = formatNumber(rowData.Visualizzazioni);
    const interazioni = formatNumber(rowData.Interazioni);

    // This truncation is for the SVG generation, can be different from table view
    const words = copyText.split(' ');
    const lines = [];
    let currentLine = '';
    const maxCharsPerLine = 62;
    const maxLines = 3; // Keep 3 lines for SVG

    for (let i = 0; i < words.length; i++) {
        const word = words[i];
        const testLine = currentLine ? currentLine + ' ' + word : word;
        if (testLine.length <= maxCharsPerLine) {
            currentLine = testLine;
        } else {
            lines.push(currentLine);
            currentLine = word;
        }
        if (lines.length === maxLines - 1 && i < words.length - 1) {
            let remainingWords = words.slice(i + 1).join(' ');
            let lastLineWithEllipsis = currentLine;
            const ellipsis = ' (...)';
            while ((lastLineWithEllipsis + ' ' + remainingWords).length > maxCharsPerLine && remainingWords.includes(' ')) {
                const lastSpaceIndex = remainingWords.lastIndexOf(' ');
                if (lastSpaceIndex === -1) break;
                remainingWords = remainingWords.substring(0, lastSpaceIndex);
            }
            lastLineWithEllipsis = (lastLineWithEllipsis ? lastLineWithEllipsis + ' ' : '') + remainingWords;
            while (lastLineWithEllipsis.length + ellipsis.length > maxCharsPerLine && lastLineWithEllipsis.includes(' ')) {
                const lastSpaceIndex = lastLineWithEllipsis.lastIndexOf(' ');
                lastLineWithEllipsis = lastLineWithEllipsis.substring(0, lastSpaceIndex);
            }
            lines.push(lastLineWithEllipsis + ellipsis);
            currentLine = '';
            break;
        }
    }
    if (currentLine && lines.length < maxLines) {
        lines.push(currentLine);
    }
    const copyTSpan = lines.map((line, index) => `<tspan x="30" dy="${index === 0 ? 0 : 30}">${line}</tspan>`).join('');

    const yStatsBlock = 415;
    const yArgomento = 125;
    const yDataPubblicazione = 226;
    const yCopyText = 290;
    const yLabelTitle = 55;

    return `
<svg width="868" height="441" viewBox="0 0 868" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="868" height="441" fill="transparent"/>
    <rect x="0" y="0" width="868" height="77" fill="#E1E9F6"/>
    <text x="434" y="${yLabelTitle}" font-family="Arial, sans-serif" font-size="40" fill="#0A4BB8" text-anchor="middle" alignment-baseline="middle">${label}</text>
    <text x="30" y="${yArgomento}" font-family="Arial, sans-serif" font-size="30" font-weight="bold" fill="#0A4BB8">${argomento}</text>
    <text x="130" y="${yDataPubblicazione}" font-family="Arial, sans-serif" font-size="30" fill="#666666">Pubblicato il ${dataPubblicazione}</text>
    <text x="30" y="${yCopyText}" font-family="Arial, sans-serif" font-size="30" fill="#666666">${copyTSpan}</text>
    <text x="30" y="${yStatsBlock}" font-family="Arial, sans-serif" font-size="32" fill="#0A4BB8" font-weight="bold">Visualizzazioni:</text>
    <text x="270" y="${yStatsBlock}" font-family="Arial, sans-serif" font-size="32" fill="#666666">${visualizzazioni}</text>
    <text x="410" y="${yStatsBlock}" font-family="Arial, sans-serif" font-size="32" fill="#0A4BB8" font-weight="bold">Interazioni:</text>
    <text x="590" y="${yStatsBlock}" font-family="Arial, sans-serif" font-size="32" fill="#666666">${interazioni}</text>
</svg>`;
}
</script>
</body>
</html>
